#!/bin/bash
# Nivo pre-commit hook
# Runs formatting, linting, and security checks before commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "âœ… No Go files to check"
    exit 0
fi

# Check 1: Go formatting
echo "ğŸ“ Checking Go formatting..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES)
if [ -n "$UNFORMATTED" ]; then
    echo "âŒ Go files must be formatted with gofmt:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: make fmt"
    echo "Or: gofmt -s -w ."
    exit 1
fi
echo "âœ… Go formatting passed"

# Check 2: Go vet
echo "ğŸ” Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet found issues"
    exit 1
fi
echo "âœ… go vet passed"

# Check 3: golangci-lint (if installed)
if command -v golangci-lint > /dev/null 2>&1; then
    echo "ğŸ§¹ Running golangci-lint..."
    if ! golangci-lint run --timeout=2m --fast ./...; then
        echo "âŒ golangci-lint found issues"
        echo ""
        echo "Fix issues or bypass with: git commit --no-verify"
        exit 1
    fi
    echo "âœ… golangci-lint passed"
else
    echo "âš ï¸  golangci-lint not installed, skipping lint check"
    echo "   Install with: make install-lint"
fi

# Check 4: Security - check for potential secrets
echo "ğŸ” Checking for potential secrets..."
patterns="password\s*[=:]\s*['\"][^'\"]{8,}['\"]|secret\s*[=:]\s*['\"][^'\"]{16,}['\"]|token\s*[=:]\s*['\"][^'\"]{20,}['\"]"
if git diff --cached --name-only | xargs grep -lE "$patterns" 2>/dev/null; then
    echo "âŒ Potential secrets detected in commit"
    echo "   Review files and remove sensitive data"
    echo ""
    echo "If this is a false positive, bypass with: git commit --no-verify"
    exit 1
fi
echo "âœ… No secrets detected"

# Check 5: Build check
echo "ğŸ”¨ Running build check..."
if ! go build ./...; then
    echo "âŒ Build failed"
    exit 1
fi
echo "âœ… Build passed"

echo ""
echo "âœ… All pre-commit checks passed!"
exit 0
